name: Poll Telegram for Commands

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  poll:
    runs-on: ubuntu-latest
    outputs:
      new_offset: ${{ steps.save.outputs.new_offset }}
    steps:
      - name: Load Offset from GITHUB_STATE
        id: load
        run: |
          OFFSET="${{ env.TELEGRAM_OFFSET }}"
          if [ -z "$OFFSET" ] || [ "$OFFSET" = "null" ]; then
            OFFSET=0
            echo "First run, starting from offset: 0"
          else
            echo "Loaded offset from previous run: $OFFSET"
          fi
          echo "offset=$OFFSET" >> $GITHUB_OUTPUT

      - name: Get Updates
        id: updates
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
        run: |
          OFFSET=${{ steps.load.outputs.offset }}
          echo "Polling from offset: $OFFSET"
          UPDATES=$(curl -s "https://api.telegram.org/bot$TG_BOT_TOKEN/getUpdates?offset=$OFFSET&limit=20")
          echo "updates<<EOF" >> $GITHUB_OUTPUT
          echo "$UPDATES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          MAX_ID=$(echo "$UPDATES" | jq -r '.result[].update_id' | sort -nr | head -1)
          if [ "$MAX_ID" != "null" ] && [ -n "$MAX_ID" ]; then
            NEW_OFFSET=$((MAX_ID + 1))
            echo "New offset: $NEW_OFFSET"
          else
            NEW_OFFSET=$OFFSET
            echo "No new updates"
          fi
          echo "new_offset=$NEW_OFFSET" >> $GITHUB_OUTPUT
          echo "TELEGRAM_OFFSET=$NEW_OFFSET" >> $GITHUB_STATE

      - name: Respond to /start
        if: contains(steps.updates.outputs.updates, '/start')
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
            -d chat_id="$TG_CHAT_ID" \
            -d text="Bot 已就绪！发 /retry 触发任务" \
            -d parse_mode="Markdown"

      - name: Trigger on /retry
        if: contains(steps.updates.outputs.updates, '/retry')
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          echo "检测到 /retry，触发主任务"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $GH_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/wispbyte-auto-login.yml/dispatches \
            -d '{"ref":"main"}')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" = "204" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
              -d chat_id="$TG_CHAT_ID" \
              -d text="Workflow 已触发重试！"
          else
            curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
              -d chat_id="$TG_CHAT_ID" \
              -d text="触发失败：HTTP $HTTP_CODE"
          fi

      - name: Save Offset for Next Run
        id: save
        run: |
          echo "new_offset=${{ steps.updates.outputs.new_offset }}" >> $GITHUB_OUTPUT
          echo "Offset saved to GITHUB_STATE: ${{ steps.updates.outputs.new_offset }}"
